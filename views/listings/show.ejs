<% layout("layouts/boilerplate") %>

<script>
  const mapToken = "<%= process.env.MAP_TOKEN %>";
  const listing = "<%- JSON.stringify(listing) %>";
</script>

<div class="container mt-4">

  <h3 class="mb-4 text-center fw-bold"><%= listing.title %></h3>

  <div class="card shadow-lg mb-4 mx-auto listing-card" style="max-width: 700px;">

    <!-- IMAGE -->
    <img 
      src="<%= listing.image && listing.image.url ? listing.image.url : 'https://via.placeholder.com/700x400?text=No+Image+Available' %>" 
      class="card-img-top rounded-top" 
      alt="<%= listing.title %>" 
      style="object-fit: cover; height: 380px; width: 100%;"
    >

    <div class="card-body">

      <!-- OWNER -->
      <p class="card-text text-muted mb-3">
        Owned by <i><%= listing.owner?.username || "Unknown Owner" %></i>
      </p>

      <!-- DESCRIPTION -->
      <p class="card-text text-muted mb-3">
        <%= listing.description || "No description available." %>
      </p>

      <!-- DETAILS -->
      <ul class="list-group list-group-flush mb-3">

        <li class="list-group-item">
          <strong>Price:</strong>
          <% if (listing.price) { %>
            <span class="text-success fw-semibold">
              ‚Çπ <%= listing.price.toLocaleString("en-IN") %>
            </span>
          <% } else { %>
            Not specified
          <% } %>
        </li>

        <li class="list-group-item">
          <strong>Location:</strong>
          <%= listing.location || "Not specified" %>
        </li>

        <li class="list-group-item">
          <strong>Country:</strong>
          <%= listing.country || "Not specified" %>
        </li>

      </ul>

      <!-- OWNER ACTIONS -->
      <% if (currUser && listing.owner && currUser._id.toString() === listing.owner._id.toString()) { %>
        <div class="d-flex justify-content-between gap-2 mb-3">
          <a href="/listings/<%= listing._id %>/edit" class="btn btn-primary flex-fill">
            <i class="bi bi-pencil-square"></i> Edit
          </a>

          <form 
            method="POST" 
            action="/listings/<%= listing._id %>?_method=DELETE"
            onsubmit="return confirm('Are you sure you want to delete this listing?');"
            class="flex-fill"
          >
            <button type="submit" class="btn btn-danger w-100">
              <i class="bi bi-trash3"></i> Delete
            </button>
          </form>
        </div>
      <% } %>

      <a href="/listings" class="btn btn-secondary w-100">
        <i class="bi bi-arrow-left"></i> Back to Listings
      </a>
    </div>

    <hr class="m-0">

    <!-- MAP SECTION  -->
    <% if (listing.geometry && listing.geometry.coordinates) { %>
    <div class="p-4">
      <h4 class="fw-bold mb-3">üìç Where you'll be</h4>
      <div id="map" style="height: 300px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
    </div>
    <hr class="m-0">
    <% } %>

    <!-- REVIEW SECTION -->
    <div class="p-4">

      <% if (currUser) { %>

        <h4 class="fw-bold mb-3">Leave a Review</h4>

        <form 
          action="/listings/<%= listing._id %>/reviews" 
          method="POST" 
          class="needs-validation"
          novalidate
        >

          <!-- STAR RATING -->
          <fieldset class="starability-slot mb-4">
            <legend class="form-label fw-semibold">Rating:</legend>

            <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating" />

            <% for (let i = 1; i <= 5; i++) { %>
              <input type="radio" id="rate<%= i %>" name="review[rating]" value="<%= i %>" />
              <label for="rate<%= i %>"><%= i %> star<%= i > 1 ? 's' : '' %></label>
            <% } %>
          </fieldset>

          <!-- COMMENT -->
          <div class="mb-3">
            <label for="comment" class="form-label fw-semibold">Comments</label>
            <textarea 
              name="review[comment]" 
              id="comment" 
              rows="4" 
              class="form-control" 
              placeholder="Write your thoughts..."
              required
            ></textarea>
            <div class="invalid-feedback">Please write a comment.</div>
          </div>

          <button type="submit" class="btn btn-success w-100">
            <i class="bi bi-send"></i> Submit Review
          </button>
        </form>

      <% } else { %>
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> Please <a href="/login" class="alert-link">login</a> to leave a review.
        </div>
      <% } %>

      <!-- ALL REVIEWS -->
      <% if (listing.reviews && listing.reviews.length > 0) { %>

        <h5 class="fw-bold mt-5 mb-3">All Reviews (<%= listing.reviews.length %>)</h5>

        <div class="row g-3">

          <% for (let review of listing.reviews) { %>
            <div class="col-12 col-md-6">
              <div class="card shadow-sm h-100">

                <div class="card-body pb-2">
                  <h6 class="card-title fw-semibold">
                    <i class="bi bi-person-circle"></i> @<%= review.author?.username || "Anonymous" %>
                  </h6>

                  <p class="starability-result mb-2" data-rating="<%= review.rating %>"></p>

                  <p class="card-text"><%= review.comment %></p>
                </div>

                <% if (currUser && review.author && currUser._id.toString() === review.author._id.toString()) { %>
                  <div class="card-footer bg-transparent border-0 pt-0">
                    <form 
                      method="POST" 
                      action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                      onsubmit="return confirm('Are you sure you want to delete this review?');"
                    >
                      <button class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash3"></i> Delete
                      </button>
                    </form>
                  </div>
                <% } %>

              </div>
            </div>
          <% } %>

        </div>

      <% } else { %>
        <p class="text-muted mt-4 text-center">
          <i class="bi bi-chat-left-text"></i> No reviews yet. Be the first to review!
        </p>
      <% } %>

    </div>

  </div>
</div>

<script src="/js/map.js"></script>